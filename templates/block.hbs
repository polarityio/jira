<div class="d-flex justify-content-between align-items-center">
  {{#if details.jql}}
    <div class="mb-1">
      <a class="p-link" href="{{jiraFqdn}}/issues/?jql={{details.jql}}">Run search in Jira {{fa-icon icon="external-link"
                                                                                                     fixedWidth=true
                                                                                                     class="external-link-icon"}}</a>
    </div>
  {{/if}}
  {{#if (and (not state.createIssue.showCreateIssue)(not-eq block.userOptions.enableCreatingIssues.value "disabled"))}}
    <div class="add-comment-btn-container">
      <span class="p-action" {{action (pipe (action "loadProjects")(toggle "createIssue.showCreateIssue" state))}}>
        {{fa-icon icon="plus-circle"}} Create Issue
      </span>
    </div>
  {{/if}}
</div>

{{!-- Beginning of Create Issue Form --}}
{{#if state.createIssue.showCreateIssue}}
  <div class="create-issue-container">  
    <div class="input-container">
      <label class="small ifta-label">
        Project
        <span class="required">*</span>
      </label>
      <select
        class="ifta-field"
        {{on "change" (pipe-action (pick "target.value" (set state.createIssue "selectedProjectId"))(action "loadIssueTypes"))}}
        required=true
        disabled={{state.createIssue.loadingProjects}}
      >
        {{#if state.createIssue.loadingProjects}}
          <option selected>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Loading projects ...</option>
        {{else}}
          <option selected disabled>Select a project</option>
        {{/if}}
        {{#each state.createIssue.projects as | project |}}
          <option value="{{project.id}}" selected={{if (eq state.createIssue.selectedProjectId project.id) true}}>{{project.name}} ({{project.key}})</option>
        {{/each}}
      </select>
      {{#if state.createIssue.loadingProjects}}
          {{fa-icon icon="spinner-third" spin=true class="select-loading-spinner"}}
      {{/if}}
      {{fa-icon icon="chevron-down" fixedWidth=true class="select-arrow"}}
    </div>
    <div class="input-container">
      <label class="small ifta-label">
        Issue Type
        <span class="required">*</span>
      </label>
      <select
        class="ifta-field"
        {{on "change" (pipe-action (pick "target.value" (set state.createIssue "selectedIssueType"))(action "loadIssueFields" state.createIssue.selectedProjectId state.createIssue.selectedIssueType))}}
          required=true
          disabled={{or state.createIssue.loadingIssueTypes state.createIssue.loadingProjects (not state.createIssue.selectedProjectId)}}
      >
        {{#if state.createIssue.loadingIssueTypes}}
          <option selected>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Loading issue types ...</option>
        {{else}}
          <option selected disabled>Select an Issue Type</option>
        {{/if}}
        {{#each state.createIssue.issueTypes as | issueType |}}
          <option value="{{issueType.id}}" selected={{if (eq state.createIssue.selectedIssueType issueType.id) true}}>{{issueType.name}}</option>
        {{/each}}
      </select>
      {{#if state.createIssue.loadingIssueTypes}}
        {{fa-icon icon="spinner-third" spin=true class="select-loading-spinner"}}
      {{/if}}
      {{fa-icon icon="chevron-down" fixedWidth=true class="select-arrow"}}
    </div>
    {{#if state.createIssue.loadingIssueFields}}
      <div class="mb-2">
        {{fa-icon icon="spinner-third" spin=true}} Loading fields ...
      </div>
    {{/if}}
    {{#if (and (not state.createIssue.loadingIssueFields) displayIssueFields)}}
      {{#each state.createIssue.issueFields as | field |}}
        {{!-- We go from more specific fields to less specific --}}
        {{#if
          (or 
            (eq field.schema.system "summary")
            (and (eq field.schema.type "string")(eq field.required true))
          )
        }}
          <div class="input-container" {{did-insert (set field "__isRendered" true)}}>
            <label class="small ifta-label">
              {{field.name}}
              {{#if field.required}}
                <span class="required">*</span>  
              {{/if}}                
            </label>
            {{input
              class=(concat "ifta-field" (if field.__error " error"))
              value=field.__value
              placeholder=(get uiElement "placeholder")
              disabled=state.createIssue.isCreatingIssue
              required=(if field.required true false)
            }}
          </div>
        {{else if (eq field.schema.system "description")}}
          <div 
            class="input-container text-area-container {{if block._state.isSending "disabled"}} {{if field.__error "error"}}"
            {{did-insert (set field "__isRendered" true)}}
          >
            <label class="small">
              {{field.name}}
              {{#if field.required}}
                <span class="required">*</span>
              {{/if}}
            </label>
            {{textarea
                class="ifta-field"
                rows=5
                placeholder=(get uiElement "placeholder")
                value=field.__value
                disabled=state.createIssue.isCreatingIssue
                required=(if field.required true false)
            }}
          </div>
        {{/if}}
        {{#if field.__error}}
          <div class="ifta-error-message">
            {{field.__error}}
          </div>
        {{/if}}
    {{/each}}
    {{/if}}
    <button class="btn btn-polarity" {{action "createIssue"}} disabled={{if (or (not displayIssueFields) state.createIssue.isCreatingIssue) true}}>
      {{#if state.createIssue.isCreatingIssue}}
        {{fa-icon icon="spinner-third" spin=true fixedWidth=true}}
      {{else}}
        Create
      {{/if}}
    </button>
    <button class="btn btn-cancel" {{action (pipe-action (toggle "createIssue.showCreateIssue" state)(action "clearCreateIssuefields"))}} disabled={{if state.createIssue.isCreatingIssue true}}>Cancel</button>

    {{#if state.createIssue.errorMessage}}
      <div class="alert alert-danger error-message mt-2">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="error-message-title">
            {{#if state.createIssue.errorTitle}}
              {{state.createIssue.errorTitle}}
            {{else}}
              Unexpected Error Occurred
            {{/if}}            
          </div>
          <div>
            {{fa-icon icon="times" fixedWidth=true click=(set state "createIssue.errorMessage" "") class="close-icon"}}
          </div>
        </div>
        <div class="error-scrolling-container">
          <pre>{{state.createIssue.errorMessage}}</pre>
        </div>
      </div>
    {{/if}}
  </div>
{{/if}}
{{!-- End of Create Issue Form --}}

{{!-- Created Issue Success Container --}}
{{#if state.createIssue.lastCreatedIssue}}
  <div class="issue-created-container">
    <div class="d-flex align-items-center">
      Successfully created Issue {{state.createIssue.lastCreatedIssue}}
    </div>
    <div class="mt-1">
      <span class="p-action" {{action "runSearchInPolarity" state.createIssue.lastCreatedIssue}}>{{fa-icon icon="search" fixedWidth=true class="external-link-icon"}} Open in Polarity</span>
    </div>
    <div class="mt-1">
      <a class="d-flex align-items-center" href="{{jiraFqdn}}/browse/{{state.createIssue.lastCreatedIssue}}" target="_blank">
        {{fa-icon icon="external-link" fixedWidth=true class="external-link-icon mr-1"}} View in Jira
      </a>
    </div>
  </div>
{{/if}}
{{!-- End of Created Issue Success Container --}}

{{!-- Beginning of Paging Header --}}
{{#if (gt filteredPagingData.length 0)}}
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="pl-0 page-info p-footnote">
      {{#if (gt filteredPagingData.length pageSize)}}
        Viewing search results {{pagingStartItem}} - {{pagingEndItem}} of {{filteredPagingData.length}}
      {{else}}
        Viewing {{filteredPagingData.length}} search results
      {{/if}}
    </div>
  </div>
{{else}}
  <div class="p-footnote">
    No results found
  </div>
{{/if}}
{{!-- End of Paging Header --}}



{{#each pagedPagingData as |issue issueIndex|}}
  <div class="issue-container">
    <div class="d-flex align-items-center justify-content-between">
      <h1 class="p-title mt-0">
        {{#if (gt details.issues.length 1)}}
          <span class="mr-1">#{{issue.__index}}</span>
        {{/if}}
        <a class="d-flex align-items-center" href="{{jiraFqdn}}/browse/{{issue.key}}" target="_blank">
          {{#if state.isDetailsLoading}}
            {{fa-icon icon="spinner-third" fixedWidth=true spin=true class=title-icon}}
          {{else}}
            <img class="title-icon mr-1" src="{{get details.icons issue.fields.project.__iconMd5}}"/>  
          {{/if}}        
          {{issue.fields.project.name}}
          <span class="pl-1 pr-1">/</span>
          {{#if state.isDetailsLoading}}
            {{fa-icon icon="spinner-third" fixedWidth=true spin=true class=title-icon}}
          {{else}}
            <img class="title-icon mr-1" src="{{get details.icons issue.fields.issuetype.__iconMd5}}"/>
          {{/if}}
          {{issue.key}}
        </a>
      </h1>
      {{#if issue.__updating}}
        {{fa-icon icon="spinner-third" spin=true fixedWidth=true}}
      {{/if}}
    </div>
  
    {{#if issue.fields.summary}}
      <h1 class="p-title">
        {{issue.fields.summary}}
      </h1>
    {{/if}}
    
    {{#if issue.fields.status.name}}
      {{#let (get permissions issue.id) as | issuePermissions |}}
        {{#if (and block.userOptions.enableUpdatingStatus issuePermissions.TRANSITION_ISSUES)}}
          <div class="status-select mb-1">
            <div class="label p-key">
              <div class="p-1">
                Status
              </div>
            </div>
            <select disabled={{if (or issue.__updating state.isDetailsLoading) true}} onchange={{action (action "updateIssueTransition" issueIndex issue.id) value="target.value"}}>
              {{#each issue.transitions as | transition |}}
                <option value="{{transition.id}}" selected={{eq transition.to.id issue.fields.status.id}}>
                  {{transition.name}}
                </option>            
              {{/each}}
            </select>          
          </div>
        {{else}}
          <div>
            <span class="p-key">Current Status:</span>
            <span class="p-value">{{issue.fields.status.name}}</span>
          </div>
        {{/if}}      
      {{/let}}
    {{/if}}
    {{#if issue.fields.issuetype.name}}
      <div>
        <span class="p-key">Issue Type:</span>
        <span class="p-value">{{issue.fields.issuetype.name}}</span>
      </div>
    {{/if}}
    {{#if issue.fields.project.projectTypeKey}}
      <div>
        <span class="p-key">Project Type:</span>
        <span class="p-value">{{issue.fields.project.projectTypeKey}}</span>
      </div>
    {{/if}}
    {{#if issue.fields.priority.name}}
      <div>
        <span class="p-key">Priority:</span>
        <span class="p-value">{{issue.fields.priority.name}}</span>
      </div>
    {{/if}}
  
    {{#if details.fields.creator.displayName}}
      <div>
        <span class="p-key">Creator:</span>
        <span class="p-value"><a href="{{jiraFqdn}}/people/{{issue.fields.creator.accountId}}"
                                 target="_blank">{{issue.fields.creator.displayName}}</a></span>
      </div>
    {{/if}}
  
    {{#if (and issue.fields.reporter.accountId issue.fields.reporter.displayName)}}
      <div>
        <span class="p-key">Reporter:</span>
        <span class="p-value"><a href="{{jiraFqdn}}/people/{{issue.fields.reporter.accountId}}"
                                 target="_blank">{{issue.fields.reporter.displayName}}</a></span>
      </div>
    {{/if}}
  
    {{#if issue.fields.assignee.displayName}}
      <div>
        <span class="p-key">Assignee:</span>
        <span class="p-value"><a href="{{jiraFqdn}}/people/{{issue.fields.assignee.accountId}}"
                                 target="_blank">{{issue.fields.assignee.displayName}}</a></span>
      </div>
    {{/if}}
  
    {{#if issue.fields.resolution.name}}
      <div>
        <span class="p-key">Issue Resolution:</span>
        <span class="p-block">{{issue.fields.resolution.name}}</span>
      </div>
    {{/if}}
  
    {{#if issue.fields.resolutiondate}}
      <div>
        <span class="p-key">Issue Resolution Date:</span>
        <span class="p-value">{{moment-format issue.fields.resolutiondate "YYYY-MM-DD HH:mm:ss z"
                                              timeZone=timezone}}</span>
      </div>
    {{/if}}
  
    {{#if issue.fields.created}}
      <div>
        <span class="p-key">Created:</span>
        <span class="p-value">{{moment-format issue.fields.created "YYYY-MM-DD HH:mm:ss z" timeZone=timezone}}</span>
      </div>
    {{/if}}
  
    {{#if issue.fields.updated}}
      <div>
        <span class="p-key">Updated:</span>
        <span class="p-value">{{moment-format issue.fields.updated "YYYY-MM-DD HH:mm:ss z" timeZone=timezone}}</span>
      </div>
    {{/if}}
  
    {{#if issue.fields.labels}}
      <h1 class="p-title">
        Labels
      </h1>
  
      <div class="tags">
        {{#each issue.fields.labels as |label|}}
          <span class="pulse-tag">{{label}}</span>
        {{/each}}
      </div>
    {{/if}}
  
    {{#if issue.fields.fixVersions}}
      <h1 class="p-title">
        {{fa-icon "calendar"}} Fix Versions
      </h1>
  
      {{#each issue.fields.fixVersions as |version|}}
        <div class="mb-2">
          {{#if version.name}}
            <div>
              <span class="p-key">Version Name:</span>
              <span class="p-value">{{version.name}}</span>
            </div>
          {{/if}}
          {{#if version.releaseDate}}
            <div>
              <span class="p-key">Version Release Date:</span>
              <span class="p-value">{{version.releaseDate}}</span>
            </div>
          {{/if}}
          {{#if version.description}}
            <div>
              <span class="p-key">Version Description:</span>
              <span class="description">{{version.description}}</span>
            </div>
          {{/if}}
        </div>
      {{/each}}
    {{/if}}
  
  
    <ul class="nav nav-tabs mt-2">
      {{#if issue.renderedFields.description}}
        <li class="nav-item">
          <a
            {{action (mut issue.__activeTab) "description"}}
                  class="nav-link {{if (or (eq issue.__activeTab "description")(not issue.__activeTab)) "active"}}"
                  href="#"
          >
            Description
          </a>
        </li>
      {{/if}}
      <li class="nav-item">
        <a {{action (mut issue.__activeTab) "comments"}} class="nav-link {{if (eq issue.__activeTab "comments") "active"}}" href="#">
          Comments
          {{#if state.isDetailsLoading}}
            {{fa-icon icon="spinner-third" spin=true fixedWidth=true}}
          {{else}}
            ({{issue.comments.length}})  
          {{/if}}        
        </a>
      </li>    
    </ul>

    {{!-- Description Tab --}}
    {{#if (or (eq issue.__activeTab "description")(not issue.__activeTab))}}
      <div class="mt-1">
        <span class="description jira-html">{{{issue.renderedFields.description}}}</span>
      </div>
    {{/if}}
  
    {{!-- Comments Tab --}}
    {{#if (eq issue.__activeTab "comments")}}
      <div class="mt-1">
        {{#if (eq issue.comments.length 0)}}
          No Comments
        {{/if}}
        {{#let (get permissions issue.id) as | issuePermissions |}}
          {{#if (and issuePermissions.ADD_COMMENTS block.userOptions.enableAddingComments)}}
            {{#unless issue.__showAddComment}}
              <div class="add-comment-btn-container">
                <span class="p-action" {{action (toggle "__showAddComment" issue)}}>
                  {{fa-icon icon="plus-circle"}} Add Comment
                </span>
              </div>
            {{/unless}}
            {{#if issue.__showAddComment}}
              <div class="add-comment-form-container mb-2">
                <div class="mb-1">
                  <textarea
                    class="form-control" 
                    rows="3" 
                    value={{issue.__commentText}}
                    onInput={{action (mut issue.__commentText) value="target.value"}}>                    
                  </textarea>
                </div>
                {{!--
                <div class="write-container">
                  <div class="mt-2">
                    Data from selected integrations will be submitted as part of the comment in JSON format.
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="p-action {{if (eq state.integrations.length 0) "invisible"}}" {{action "toggleAllIntegrations"}}>
                      Toggle All Integrations
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="p-footnote {{if (eq state.integrations.length 0) "invisible"}}">
                        {{numSelectedWriteIntegrations}} selected
                      </div>
                      <button class="btn ml-1 icon-btn p-action" {{action "refreshIntegrations"}} title="Refresh integrations">
                        {{fa-icon icon="sync" fixedWidth=true spin=state.spinRefresh}}
                      </button>
                    </div>
                  </div>
                  <div
                    class="integration-labels-container {{if state.missingIntegrations "error-text"}} {{if state.isWriting "disabled"}}"
                  >
                    {{#each state.integrations as | integration |}}
                      <label class="integration-write-label d-flex align-items-center">
                        <input
                                disabled={{state.isWriting}}
                                type="checkbox"
                                checked={{integration.selected}}
                                onclick={{action (mut integration.selected) value="target.checked"}}
                        >
                        <div class="label-text">
                          {{integration.integrationName}}
                        </div>
                      </label>
                    {{/each}}
                    {{#if (eq state.integrations.length 0)}}
                      <div>No integration data available.</div>
                      <div class="p-action mt-1" {{action "refreshIntegrations"}}>Click here to refresh integration data</div>
                    {{/if}}
                  </div>
                  <div class="integration-labels-description p-footnote {{if state.missingIntegrations "error-text"}}">
                    {{#if (eq state.integrations.length 0)}}
                      At least one integration must return data before you can submit evidence.
                    {{else}}
                      Select one or more integrations to use as Evidence
                    {{/if}}
                  </div>
                </div>
                --}}
                <button class="btn btn-polarity" {{action "addComment" issueIndex issue.id issue.__commentText}} disabled={{if (or (not issue.__commentText) state.isDetailsLoading issue.__savingComment) true}}>
                  {{#if issue.__savingComment}}
                    {{fa-icon icon="spinner-third" spin=true fixedWidth=true}}
                  {{else}}
                    Save
                  {{/if}}
                </button>
                <button class="btn btn-cancel" {{action "cancelComment" issueIndex}} disabled={{if issue.__savingComment true}}>Cancel</button>
              </div>
            {{/if}}
          {{/if}}
        {{/let}}
        {{#each issue.comments as |comment|}}
          <div class="comment-container">
            <div class="d-flex align-items-center">
              {{#if comment.author}}
                <img class="author-avatar" src="{{comment.author.avatarUrls.24x24}}"/>
                <div class="ml-1">{{comment.author.displayName}}</div>
              {{else}}
                {{fa-icon icon="user-circle" fixedWidth=true class="user-avatar-icon"}}
                <div class="ml-1">Anonymous</div>
              {{/if}}
              <div class="p-footnote ml-1" title="{{comment.created}}">{{moment-from-now comment.created}}</div>
              {{#if (not-eq comment.created comment.updated)}}
                <div class="p-footnote ml-1" title="{{comment.updated}}">(edited)</div>
              {{/if}}
            </div>
            <div class="w-100 jira-html mt-1">
              {{{comment.renderedBody}}}
            </div>
          </div>
        {{/each}}
      </div>
    {{/if}}
    
    {{!-- flashMessage container --}}
    {{#if issue.__flashMessage}}
      <div class="flash-message-container {{issue.__flashMessageType}}">
        <div>{{issue.__flashMessage}}</div>
        <button type="button" class="close" {{action "clearFlashMessage" issueIndex}}>
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {{/if}}
  </div>
{{/each}}

{{!-- Result Paging component --}}
{{#if (gt filteredPagingData.length pageSize)}}
  <div class="paging-bar">
    <div>
      <span class="paging-bar-title">{{block.acronym}}</span>
    </div>
    <div class="d-flex align-items-center">
      <button class="btn paging-btn" {{action "firstPage"}} disabled={{isPrevButtonsDisabled}}>
        {{fa-icon icon="angle-double-left" fixedWidth=false}}
      </button>
      <button class="btn paging-btn" {{action "prevPage"}} disabled={{isPrevButtonsDisabled}}>
        {{fa-icon icon="angle-left" fixedWidth=false}}
      </button>
      <div class="paging-info">
        {{#if (eq pageSize 1)}}
          {{pagingStartItem}} of {{filteredPagingData.length}}
        {{else}}
          {{pagingStartItem}} - {{pagingEndItem}} of {{filteredPagingData.length}}
        {{/if}}
      </div>
      <button class="btn paging-btn" {{action "nextPage"}} disabled={{isNextButtonDisabled}}>
        {{fa-icon icon="angle-right" fixedWidth=false}}
      </button>
      <button class="btn paging-btn" {{action "lastPage"}} disabled={{isNextButtonDisabled}}>
        {{fa-icon icon="angle-double-right" fixedWidth=false}}
      </button>
    </div>
  </div>
{{/if}}
{{!-- End of Paging Component --}}